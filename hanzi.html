<!DOCTYPE html>
<html lang="zh">
    <head>
        <title>Hanzi Chart</title>
        <meta charset="UTF-8">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="main.css">
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@100..900&display=swap" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    </head>
    <body>
        <h1 class="no-print">Generador de Plantillas Hanzi</h1>

        <table id="t" class="grid-10mm">
            <tbody>
            </tbody>
        </table>
        <form id="f" class="no-print" onsubmit="false">
            <div class="label"><span>Tamaño: </span><select id="grid-size"><option value="grid-10mm">10mm</option><option value="grid-17mm">17mm</option></select></div>
            <div class="label"><span>Hanzis: </span><textarea id="hanzis" cols="30" rows="7"></textarea></div>
            <div class="label"><span></span><button type="button" id="btnUpdate">Actualizar</button> &nbsp; <button type="button" id="btnLink">Copiar Enlace</button></div>
            <div class="label"><span></span><keyboard>
                Caracteres especiales <br>(pulsar para insertar):<br>
                <button>á</button><button>é</button><button>í</button><button>ó</button><button>ú</button><button>ǘ</button><br>
                <button>à</button><button>è</button><button>ì</button><button>ò</button><button>ù</button><button>ǜ</button><br>
                <button>ā</button><button>ē</button><button>ī</button><button>ō</button><button>ū</button><button>ǖ</button><br>
                <button>ǎ</button><button>ě</button><button>ǐ</button><button>ǒ</button><button>ǔ</button><button>ǚ</button>
            </keyboard></div>
            <div class="label"><span>Plantillas de ejemplo: (<a href="javascript:loadTemplates()">recargar</a>)</span><templates>
                
            </templates></div>
        </form>
        <script type="application/javascript">

            $.fn.insertAtCaret = function(text) {
                return this.each(function() {
                    if (document.selection && this.tagName == 'TEXTAREA') {
                        //IE textarea support
                        this.focus();
                        sel = document.selection.createRange();
                        sel.text = text;
                        this.focus();
                    } else if (this.selectionStart || this.selectionStart == '0') {
                        //MOZILLA/NETSCAPE support
                        startPos = this.selectionStart;
                        endPos = this.selectionEnd;
                        scrollTop = this.scrollTop;
                        this.value = this.value.substring(0, startPos) + text + this.value.substring(endPos, this.value.length);
                        this.focus();
                        this.selectionStart = startPos + text.length;
                        this.selectionEnd = startPos + text.length;
                        this.scrollTop = scrollTop;
                    } else {
                        // IE input[type=text] and other browsers
                        this.value += text;
                        this.focus();
                        this.value = this.value;    // forces cursor to end
                    }
                });
            };

            function Template(id, label, contents) {
                this.id = id;
                this.label = label;
                this.contents = contents;
            }

            var templates = {
                "numbers": new Template("numbers", "Números", "líng 零\nyī 一\nèr 二\nliǎng 两\nsān 三\nsì 四\nwǔ 五\nliù 六\nqī 七\nbā 八\njiǔ 九\nshí 十\nbǎi 百\nqiān 千\nwàn 万"),
                "salutations": new Template("salutations", "Saludos", "wǒ 我\nnǐ 你\nnín 您\ntā 他\ntā 她\ntā 它\nmen 们\nzǎo 早 shang 上 hǎo 好\nxià 下 wǔ 午 hǎo 好\nwǎn 晚 shang 上 hǎo 好\nzǎo 早 ān 安\nwǔ 午 ān 安\nwǎn 晚 ān 安\nnǐ 你 hǎo 好 ma 吗\nwǒ 我 yě 也 hěn 很 hǎo 好\nnǐ 你 ne 呢"),
                "presentations1": new Template("presentations1", "Presentaciones (I)", "hěn 很 gāo 高 xìng 兴\n\nrèn 认 shi 识 nǐ 你\n\nnǐ 你 jiào 叫 shén 什 me 么 míng 名 zì 字\n\nnín 您 guì 贵 xìng 姓\n\nnǐ 你 xìng 姓 shén 什 me 么\n\nzhè 这 shì 是\n\nwǒ 我 de 的\n\nxiè 谢 xiè 谢\n\nbú 不 kè 客 qi 气\n"),
                "presentations2": new Template("presentations2", "Presentaciones (II)", "xiǎo 小 jiě 姐\n\nxiān 先 sheng 生\n\nmèi 妹 mei 妹\n\nlǎo 老 bǎn 板\n\nxià 下 shǔ 属\n\ntóng 同 shì 事\n\nnán 男 péng 朋 you 友\n\nnǚ 女 peng 朋 you 友\n\ntài 太 tai 太\n\nzhàng 丈 fu 夫\n"),
                "countries1": new Template("countries1", "Países (I)", "guó 国 jiā 家\nrén 人 mín 民\nzhōng 中 guó 国\nměi 美 guó 国\nyīng 英 guó 国\ndé 德 guó 国\nfǎ 法 guó 国\nyì 意 dà 大 lì 利\né 俄 luó 罗 sī 斯\nxī 西 bān 班 yá 牙\njiā 加 ná 拿 dà 大\nruì 瑞 diǎn 典\nrì 日 běn 本\nrén 人\nnǐ 你 shì 是 nǎ 哪 guó 国 rén 人\n\n"),
                "family1": new Template("family1", "Familia (I)", "nǐ 你 jiā 傢 yǒu 有 jǐ 几 kǒu 口 rén 人\n\nbà 爸 ba 爸\nmā 妈 ma 妈\nzhàng 丈 fu 夫\nqī 妻 zi 子\nyé 爷 ye 爷\nnǎi 奶 nai 奶\nwài 外 gōng 公\nwài 外 pó 婆\ngē 哥 ge 哥\ndì 弟 di 弟\njiě 姐 jie 姐\nmèi 妹 mei 妹\nxiōng 兄 dì 弟 jiě 姐 mèi 妹\nér 儿 zi 子\nnǚ 女 ér 儿"),
                "miscellaneous1": new Template("miscellaneous1", "Varios (I)", "zuó 昨 tiān 天\njīn 今 tiān 天\nmíng 明 tiān 天\nxīng 星 qī 期\nqù 去 nián 年\nmíng 明 nián 年\njīn 今 nián 年\ndiàn 电 huà 话 hào 号 mǎ 码\ndàn 但 shì 是\ndōu 都\nhé 和\nchū 出 shēng 生\nduo 多 da 大\nduo 多 shao 少\ntīng 听\nshuō 说\ndú 读\nxiě 写"),
                "zodiac1": new Template("zodiac1", "Zodiaco", "shēng 生 xiào 肖\nshǔ 属\nshǔ 鼠\nniú 牛\nhǔ 虎\ntù 兔\nlóng 龙\nshé 蛇\nmǎ 马\nyáng 羊\nhóu 猴\njī 鸡\ngǒu 狗\nzhū 猪\nxīn 新 nián 年\nzhōu 周 mò 末\nshèng 圣 dàn 诞 jié 节\nkuài 快 lè 樂"),
                "time1": new Template("time1", "Tiempo", "qián 前\nzuó 昨\njīn 今\nmíng 明\nhòu 后\nqù 去\ntiān 天\nnián 年\nyuè 月\nxīng 星 qī 期\nzhè 这\ndiǎn 点\nfēn 分\nbàn 半\ncóng 从\ndào 到"),
                "professions1": new Template("professions1", "Oficios", "zhí 职 yè 业\nlǎo 老 shī 师\ngōng 工 rén 人\nshòu 售 huò 货 yuán 员\nyī 医 shēng 生\nzhí 职 yuán 员\njiā 家 tíng 庭 zhǔ 主 fù 妇\njiā 家 tíng 庭 zhǔ 主 fū 夫\nhù 护 shì 士\nmì 秘 shū 书\nshāng 商 rén 人\ngōng 工 chéng 程 shī 师\njiàn 建 zhù 筑 shī 师\njì 记 shě 者\nlǜ 律 shī 师\nzuò 作 jiā 家\nfú 服 wù 务 yuán 员\nshè 设 jì 计 shī 师\nyùn 运 dòng 动 yuán 员\nsī 司 jī 机\nxué 学 sheng 生\nmiàn 面 bāo 包 shī 师\nfǎ 法 guān 官"),
                "workplaces": new Template("workplaces", "Lugares de Trabajo", "bàn 办 gōng 公 shì 室\nshāng 商 diàn 店\nbǎi 百 huò 货\ngōng 公 sī 司\nshū 书 fáng 房\nyǔ 语 yán 言\nxué 学 xiào 校\nfǎ 法 yuàn 院\nyī 医 yuàn 院\ngōng 工 chǎng 厂\njiā 家\nfáng 饭 guǎn 馆\ndà 大 xué 学\nsī 私 rén 人\nzhěn 诊 suǒ 所\njiàn 健 shēn 身 fáng 房\nyào 药 fáng 房\njiǔ 酒 diàn 店\nqiú 球 chǎng 场"),
                "shopping": new Template("shopping", "De compras", "yuán 元 jiǎo 角\nkuài 块 máo 毛\nqián 钱\ngōng 公 jīn 斤\nyào 要\ndà 大 xiǎo 小\nduō 多 shǎo 少\nxīn 新\njiù 旧\nguì 贵\npián 便 yi 宜\nfān 方 biàn 便\npiāo 漂 liàng 亮\nchuān 穿\nyī 衣 fu 服\njiàn 件\ntiáo 条\nshuāng 双"),
                "colors": new Template("colors", "Colores", "yán 颜 sè 色\nbái 白 sè 色\nhuī 灰 sè 色\nhēi 黑 sè 色\nhuáng 黄 sè 色\nhóng 红 sè 色\nlán 蓝 sè 色\nlǜ 绿 sè 色\nchéng 橙 sè 色\nzōng 棕 sè 色\nfěn 粉 hóng 红\nkā 咖 fēi 啡 sè 色\nqiǎn 浅 lán 蓝 sè 色\nshēn 深 lán 蓝 sè 色\njīn 金 sè 色\nyín 银 sè 色")
            };

            var createTemplate = function() {
                var text = $("#hanzis").val();
                var text = text.replaceAll("\n", "\\n");
                console.info("Template code:\n  \"" + text + "\"");
            }

            var loadTemplates = function() {
                var client = supabase.createClient("https://xihovlvpwltfvmuljbsi.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhpaG92bHZwd2x0ZnZtdWxqYnNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMyNDgxNDksImV4cCI6MjA1ODgyNDE0OX0.nqScDXbus4TXju3q0ZxpoAoit-cT3s5p7u7U0HNr57w");
                client.from("templates").select("id,name,contents").fetch(function(d, err) {
                    var data = d.data;
                    for (var i = 0; i < data.length; i++) {
                        templates[data.id] = new Template(data.id, data.name, data.contents);
                    }
                });
                initTemplates();
            }

            var initTemplates = function() {
                var root = $("templates");
                root.empty();
                for (const key in templates) {
                    if (templates.hasOwnProperty(key)) {
                        var id = templates[key].id;
                        var label = templates[key].label;
                        root.append("<br><button class='template' id='" + key + "'>" + label + "</button>")
                    }
                }
            }

            var updateChars = function() {
                var tbody, i, j;
                var contents = $("#hanzis").val().split(/[ \t\n]+/);

                tbody = $("#t tbody");
                tbody.empty();
                for (i = 0; i < contents.length; i += 2) {
                    var pinyin = contents[i + 0];
                    var hanzi = contents[i + 1];
                    var row1 = "<tr class='pinyin'>"
                    var row2 = "<tr class='hanzi'>"
                    for (j = 0; j < 17; j++) {
                        row1 += "<td>" + pinyin;
                        row2 += "<td>" + (j < 5 ? hanzi : ' ');
                    }
                    tbody.append(row1, row2);
                }
            }
            var updateWords = function() {
                var tableClass = $("#grid-size").val();
                var CELLS = 5;
                if (tableClass === "grid-10mm") {
                    CELLS = 17;
                } else if (tableClass === "grid-17mm") {
                    CELLS = 10;
                }

                var tbody, i, j, k, n, mod, contents;
                var lines = $("#hanzis").val().split(/\n/);

                tbody = $("#t tbody");
                tbody.empty();
                for (i = 0; i < lines.length; i++) {
                    contents = lines[i].trim().split(/[ \t]+/);

                    var row1 = "<tr class='pinyin'>";
                    var row2 = "<tr class='hanzi'>";
                    if (contents.length == 0) {
                        for (j = 0; j < CELLS; j++) {
                            row1 += "<td>";
                            row2 += "<td>";
                        }
                    } else {
                        mod = contents.length;
                        n = mod == 2 ? 5 : (mod / 2) * 3;
                        for (j = 0; j < CELLS; j++) {
                            var pinyin = contents[(2 * j + 0) % mod];
                            var hanzi  = contents[(2 * j + 1) % mod];
                            var tag = j < (mod / 2) ? "<td class='black'>" : "<td>";
                            row1 += tag + pinyin;
                            row2 += tag + (j < n ? hanzi : ' ');
                        }
                    }
                    tbody.append(row1, row2);
                }
            }

            var copyLink = function() {
                var text = $("#hanzis").val();
                var url = window.location.origin + window.location.pathname;
                url += "?size=" + $("#grid-size").val() + "&hanzis=" + encodeURIComponent(text);
                navigator.clipboard.writeText(url);
                console.debug("Link copied to clipboard: " + url);
            }

            var updateTemplate = function() {
                var id = this.id;
                var template = templates[id];
                $("#hanzis").val(template.contents);
                updateWords();
            }

            initTemplates();

            $("form").submit(function (e) { e.preventDefault(); });
            $("#grid-size").change(function() {
                var klass = $(this).val();
                $("#t").attr("class", klass);
                updateWords();
            })
            $("#btnUpdate").click(updateWords);
            $("#btnLink").click(copyLink);
            $("keyboard button").click(function() {
                var letter = $(this).text();
                $("#hanzis").insertAtCaret(letter);
            });
            $(".template").click(updateTemplate);
            $(document).ready(function() {
                var query = window.location.search;
                var params = new URLSearchParams(query);
                if (params.has("size")) {
                    var size = params.get("size").includes("17") ? "grid-17mm" : "grid-10mm";
                    $("#grid-size").val(size).change();
                }
                if (params.has("hanzis")) {
                    var text = params.get("hanzis");
                    $("#hanzis").val(text);
                } else {
                    $("#hanzis").val(templates["numbers"].contents);
                }
                updateWords();
            });
        </script>
    </body>
</html>